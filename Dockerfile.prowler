# =======================================================
# Dockerfile.prowler - Otimizado e com PATH For√ßado (√öltima Corre√ß√£o)
# =======================================================

FROM public.ecr.aws/docker/library/python:3.11-slim

USER root

ENV AWS_CLI_VERSION=2.15.55

# === 1. Depend√™ncias do Sistema ===
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        git bash build-essential libffi-dev libssl-dev pkg-config \
        curl jq unzip dos2unix && \
    rm -rf /var/lib/apt/lists/*

# === 2. Instala√ß√£o do AWS CLI v2 ===
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-${AWS_CLI_VERSION}.zip" -o "awscliv2.zip" && \
    unzip awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip ./aws

# === 3. Instala√ß√£o do Prowler (Correto e For√ßado) ===
RUN echo "üêç Instalando Prowler (√∫ltima vers√£o est√°vel)..." && \
    pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir prowler

# === 4. Valida√ß√£o e For√ßa de Link para /usr/local/bin (CORRE√á√ÉO DE SINTAXE) ===
RUN echo "üîç Validando instala√ß√£o e corrigindo PATH..." && \
    # 1. Tenta encontrar o prowler em locais comuns ap√≥s o pip.
    PROWLER_PATH=$(find /usr/local/bin /usr/bin /root/.local/bin /opt -name prowler -type f -executable | head -n 1 || true) && \
    \
    if [ -z "$PROWLER_PATH" ]; then \
        echo "‚ùå ERRO CR√çTICO: Prowler n√£o foi encontrado em nenhum diret√≥rio ap√≥s a instala√ß√£o." && exit 1; \
    fi && \
    \
    echo "‚úÖ Prowler encontrado em: $PROWLER_PATH" && \
    \
    # 2. Se n√£o estiver no local ideal (/usr/local/bin), criamos o link.
    if [[ "$PROWLER_PATH" != "/usr/local/bin/prowler" ]]; then \
        echo "üîó Criando link simb√≥lico de $PROWLER_PATH para /usr/local/bin/prowler" && \
        ln -sf "$PROWLER_PATH" /usr/local/bin/prowler; \
    fi && \
    \
    # 3. Teste final.
    echo "Caminho do Prowler : $PROWLER_PATH"
    /usr/local/bin/prowler --version || (echo "‚ùå Falha na execu√ß√£o do Prowler ap√≥s linkagem." && exit 1)

# === 5. Scripts e EntryPoint ===
COPY run-prowler.sh /usr/local/bin/run-prowler.sh
RUN dos2unix /usr/local/bin/run-prowler.sh && chmod +x /usr/local/bin/run-prowler.sh

# Garante a prioridade do PATH no EntryPoint
ENV PATH="/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.local/bin"

ENTRYPOINT ["/usr/local/bin/run-prowler.sh"]
