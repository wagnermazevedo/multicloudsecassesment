# =======================================================
# Dockerfile.prowler ‚Äî Build robusto para execu√ß√£o multi-cloud
# =======================================================

# Usa imagem leve com Python e ferramentas necess√°rias
FROM public.ecr.aws/docker/library/python:3.11-slim

USER root

# === Depend√™ncias do sistema ===
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        git \
        bash \
        build-essential \
        libffi-dev \
        libssl-dev \
        pkg-config \
        curl \
        jq \
        awscli \
        unzip \
        dos2unix && \
    rm -rf /var/lib/apt/lists/*

# === Clona o reposit√≥rio oficial ===
RUN echo "üì• Clonando reposit√≥rio do Prowler..." && \
    git clone --depth 1 https://github.com/prowler-cloud/prowler.git /opt/prowler && \
    ln -sf /opt/prowler/prowler /usr/local/bin/prowler && \
    chmod +x /opt/prowler/prowler /usr/local/bin/prowler

# === Instala depend√™ncias Python diretamente do projeto ===
WORKDIR /opt/prowler
RUN echo "üêç Instalando depend√™ncias Python..." && \
    pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir .

# === Convers√£o preventiva CRLF -> LF ===
RUN echo "üßπ Normalizando scripts (dos2unix)..." && \
    find /opt/prowler -type f -name "*.sh" -exec dos2unix {} \; || true && \
    dos2unix /usr/local/bin/prowler || true

# === Teste de instala√ß√£o e logs de debug ===
RUN echo "üîç Validando instala√ß√£o do Prowler..." && \
    echo "üìÇ Diret√≥rio atual: $(pwd)" && \
    echo "üìÅ Conte√∫do de /usr/local/bin:" && ls -lh /usr/local/bin && \
    echo "üìÅ Conte√∫do de /opt/prowler:" && ls -lh /opt/prowler | head && \
    echo "üìå PATH: $PATH" && \
    which prowler || echo "‚ö†Ô∏è 'prowler' ainda n√£o no PATH" && \
    prowler --version || (echo "‚ùå Falha ao validar Prowler" && exit 1)

# === Copia seu script principal ===
COPY run-prowler.sh /usr/local/bin/run-prowler.sh
RUN dos2unix /usr/local/bin/run-prowler.sh && chmod +x /usr/local/bin/run-prowler.sh

# === PATH global e EntryPoint ===
ENV PATH="/usr/local/bin:/usr/bin:/bin:/root/.local/bin:/opt/prowler:${PATH}"

ENTRYPOINT ["/usr/local/bin/run-prowler.sh"]
