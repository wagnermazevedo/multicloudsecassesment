# =======================================================
# Dockerfile.prowler - Otimizado e Robusto
# =======================================================

# Usa imagem leve com Python e ferramentas necess√°rias
FROM public.ecr.aws/docker/library/python:3.11-slim

USER root

# === Vari√°vel para a AWS CLI V2 (Para rastreabilidade) ===
ENV AWS_CLI_VERSION=2.15.55

# === Depend√™ncias do sistema e ferramentas ===
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        git \
        bash \
        build-essential \
        libffi-dev \
        libssl-dev \
        pkg-config \
        curl \
        jq \
        unzip \
        dos2unix && \
    rm -rf /var/lib/apt/lists/*

# === Instala√ß√£o do AWS CLI v2 (Manual) ===
# Garante a vers√£o 2 do CLI para melhor integra√ß√£o com STS e S3
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-${AWS_CLI_VERSION}.zip" -o "awscliv2.zip" && \
    unzip awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip ./aws

# === Instala√ß√£o do Prowler (Via PIP - √öltima Vers√£o Est√°vel) ===
# CORRE√á√ÉO CRUCIAL: O nome correto do pacote no PyPI √© 'prowler', n√£o 'prowler-cli'.
RUN echo "üêç Instalando Prowler (√∫ltima vers√£o est√°vel)..." && \
    # Atualiza o pip e ferramentas base
    pip install --no-cache-dir --upgrade pip setuptools wheel && \
    # Instala o Prowler com o nome de pacote correto: 'prowler'
    pip install --no-cache-dir prowler
    # ATEN√á√ÉO: Se isso falhar com erro de permiss√£o ou depend√™ncia, tente:
    # pip install --no-cache-dir prowler --break-system-packages


# === Teste de instala√ß√£o e logs de debug ===
RUN echo "üîç Validando instala√ß√£o do Prowler..." && \
    echo "üìå PATH: $PATH" && \
    which prowler && \
    prowler --version || (echo "‚ùå Falha ao validar Prowler" && exit 1)

# === Copia e prepara o seu script principal ===
# O script run-prowler.sh DEVE ser a vers√£o corrigida para rodar com o 'prowler' diretamente.
COPY run-prowler.sh /usr/local/bin/run-prowler.sh
RUN dos2unix /usr/local/bin/run-prowler.sh && chmod +x /usr/local/bin/run-prowler.sh

# === PATH global e EntryPoint ===
# Garante que /usr/local/bin (onde Prowler e AWS CLI est√£o) seja o primeiro no PATH.
ENV PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.local/bin"

ENTRYPOINT ["/usr/local/bin/run-prowler.sh"]
